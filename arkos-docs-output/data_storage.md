# Data & Storage — Securing the ark‑os‑noa Data Plane

## Principle

The data layer of ark‑os‑noa is built around a core principle: **keep all storage within the trust boundary**.  All artefacts—images, datasets, logs, metadata, SBOMs—are retained internally, signed and versioned.  Only signed, approved deliverables are exported.  This ensures confidentiality, integrity and provenance across the platform.

## Components

1. **Private OCI Registry:** Hosts container images, Capsule definitions, build outputs and adapters.  Using a private registry prevents untrusted images from entering the environment and allows BuildKit to push/pull from a controlled backend.
2. **MinIO (S3‑compatible object store):** Serves as the main artefact store.  It holds large files (zip archives, compiled PDFs), dataset fragments, SBOM documents, vulnerability reports and even model shards.  MinIO offers versioning, server‑side encryption (SSE) and lifecycle management.
3. **Postgres:** Stores structured metadata: run logs, profiles (`profile.json`), system cards (`system_card.md`), call graphs (`kg.json`), job statuses, policy decisions and audit trails.  Postgres also stores vector embeddings via the `pgvector` extension.
4. **Supabase:** A self‑hosted instance of Supabase augments Postgres with developer APIs, authentication and real‑time features.  It provides a convenient interface for front‑end applications and external tools until the platform fully internalises these capabilities.
5. **Vector Store:** Embeddings generated by the Embeddings Service are stored in either `pgvector` (Postgres) or a dedicated Qdrant cluster.  pgvector is enabled by default for simplicity; Qdrant can be turned on via a feature flag to support larger vector workloads.

## Policies & Best Practices

* **Immutability:** Artefacts are stored content‑addressed using SHA‑256 digests.  Tags or names are pointers to immutable content; rewriting tags triggers new versions.  This prevents tampering and ensures reproducible builds.
* **Lineage & Provenance:** Each deliverable (zip, PDF, image) links back to its inputs, tools, models and run ID.  Build provenance is stored as JSON attestation, capturing the environment, command, dependency versions and commit hashes.
* **Retention:** Short‑lived runs (e.g. experimental digests) are kept for a limited period; long‑term artefacts (e.g. official releases) are retained indefinitely.  Policies can be configured per project or domain.
* **Access Control:** The data plane uses least privilege.  Microservices receive temporary scoped tokens to access the object store or registry; access is audited.  Secrets (e.g. tokens, keys) are stored in a secrets manager (Vault) and mounted as files, never as environment variables.

## Integration with Other Components

- **Backend services:** Interact with the registry and MinIO via signed URLs or direct API calls.  BuildKit pushes images to the registry; the Registrar Service writes artefacts to MinIO and records metadata in Postgres.
- **Digest Agent:** Reads and writes to MinIO and Postgres; uploads embeddings to the vector store.  It uses the registry to store intermediate build images.
- **Model Selector and Model Servers:** Use Postgres (via pgvector or Qdrant) to store model metadata and evaluation results.  Models themselves may be stored as OCI artefacts or in MinIO shards.
- **Front‑end:** Accesses Supabase for real‑time updates and uses signed URLs to fetch artefacts from MinIO.

## One‑Liners & Conventions

```bash
# Create local directories mirroring services (for dev/testing)
mkdir -p storage/{oci,minio,postgres,supabase,artifacts} && tree -L 2 storage || ls -R storage

# Content‑address an artefact
digest=$(sha256sum output.zip | awk '{print $1}')
cp output.zip storage/artifacts/${digest}.zip
```bash

## Why Internal Data Planes Matter

Keeping storage internal reduces the attack surface and simplifies compliance.  Data never leaves the environment without explicit signing and approval.  When combined with provenance tracking, this approach ensures that every piece of data can be traced back to its origin and verified—critical for regulated environments and supply‑chain integrity.
